/* Contacts performance optimization CSS */
/* Add to existing contacts.html */

<style>
/* Optimize contact list rendering */
#contactsList {
  contain: layout style paint;
  will-change: scroll-position;
}

#contactsList > div {
  contain: layout style;
  transform: translateZ(0); /* Force GPU acceleration */
}

/* Virtual scrolling support */
.contact-item {
  min-height: 100px;
  transition: background-color 0.15s ease;
}

.contact-item:hover {
  transform: none; /* Remove hover transforms for better performance */
}

/* Optimize images */
.contact-avatar img {
  image-rendering: -webkit-optimize-contrast;
  will-change: auto;
}

/* Reduce repaints */
.contact-tags {
  contain: layout;
}
</style>

<script>
// Add debounce utility at the top of contacts.html
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Replace the existing event listeners with debounced versions
document.getElementById('searchInput').addEventListener('input', debounce(() => {
  currentPage = 1;
  loadContacts(1);
}, 300)); // 300ms debounce

document.getElementById('filterTags').addEventListener('change', debounce(() => {
  currentPage = 1;
  loadContacts(1);
}, 200));

document.getElementById('engagementFilter').addEventListener('change', debounce(() => {
  currentPage = 1;
  loadContacts(1);
}, 200));

document.getElementById('contactTypeFilter').addEventListener('change', debounce(() => {
  currentPage = 1;
  loadContacts(1);
}, 200));

// Add intersection observer for lazy loading images
const imageObserver = new IntersectionObserver((entries) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      const img = entry.target;
      const src = img.dataset.src;
      if (src) {
        img.src = src;
        img.removeAttribute('data-src');
        imageObserver.unobserve(img);
      }
    }
  });
}, {
  rootMargin: '50px' // Start loading 50px before the image is visible
});

// Apply lazy loading to images when displaying contacts
function displayContactsOptimized(contacts) {
  const container = document.getElementById('contactsList');
  if (contacts.length === 0) {
    container.innerHTML = `
      <div class="p-8 text-center text-gray-500">
        <i class="fas fa-user-friends text-4xl mb-2"></i>
        <p>No contacts found</p>
      </div>
    `;
    return;
  }

  // Use document fragment for better performance
  const fragment = document.createDocumentFragment();
  const tempDiv = document.createElement('div');
  
  tempDiv.innerHTML = contacts.map(contact => `
    <div class="contact-item p-4 hover:bg-gray-50 transition-colors">
      <div class="flex items-start justify-between">
        <div class="flex items-start space-x-4 flex-1">
          <!-- Avatar with lazy loading -->
          <div class="w-16 h-16 rounded-full flex-shrink-0 bg-gradient-to-br from-green-400 to-blue-500 flex items-center justify-center text-white font-bold text-xl overflow-hidden">
            ${contact.profilePhotoUrl 
              ? `<img data-src="${contact.profilePhotoUrl}" class="lazy-image w-full h-full object-cover" alt="${contact.name}" onerror="this.parentElement.innerHTML='<i class=\\"fas fa-user\\"></i>'">` 
              : '<i class="fas fa-user"></i>'}
          </div>
          
          <div class="flex-1">
            <!-- Name and Type -->
            <div class="flex items-center gap-2">
              <h3 class="font-bold text-lg text-gray-800">${contact.name || contact.pushName || contact.phoneNumber}</h3>
              ${contact.isBusiness ? '<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full font-semibold">BUSINESS</span>' : ''}
              ${contact.isVerified ? '<i class="fas fa-check-circle text-blue-500"></i>' : ''}
            </div>
            
            <!-- Contact Details -->
            <p class="text-gray-600 text-sm mt-1">
              <i class="fas fa-phone w-4"></i> ${contact.phoneNumber}
            </p>
            ${contact.email ? `<p class="text-gray-600 text-sm"><i class="fas fa-envelope w-4"></i> ${contact.email}</p>` : ''}
            ${contact.company ? `<p class="text-gray-600 text-sm"><i class="fas fa-building w-4"></i> ${contact.company}</p>` : ''}
            
            <!-- Tags -->
            ${contact.tags && contact.tags.length > 0 ? `
              <div class="contact-tags flex gap-2 mt-2 flex-wrap">
                ${contact.tags.map(t => `
                  <span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded">${t.tag?.name || t.name}</span>
                `).join('')}
              </div>
            ` : ''}
            
            <!-- Engagement Badge -->
            <div class="flex items-center gap-3 mt-2">
              <div class="text-xs">
                <span class="font-semibold text-gray-700">Engagement:</span>
                <span class="ml-1 px-2 py-0.5 rounded-full ${
                  contact.engagementLevel === 'high' ? 'bg-green-100 text-green-800' :
                  contact.engagementLevel === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                  contact.engagementLevel === 'low' ? 'bg-orange-100 text-orange-800' :
                  'bg-gray-100 text-gray-800'
                }">${contact.engagementLevel || 'inactive'}</span>
              </div>
              <div class="text-xs text-gray-500">
                <i class="fas fa-comments"></i> ${contact._count?.messages || 0} messages
              </div>
              ${contact.lastMessageAt ? `<div class="text-xs text-gray-500">${new Date(contact.lastMessageAt).toLocaleDateString()}</div>` : '<div class="text-xs text-gray-400">No messages</div>'}
            </div>
          </div>
          <div class="flex space-x-2">
            <button onclick="editContact('${contact.id}')" 
              class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
              <i class="fas fa-edit mr-1"></i>Edit
            </button>
            <button onclick="viewMessages('${contact.id}')" 
              class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600">
              <i class="fas fa-envelope mr-1"></i>Messages
            </button>
          </div>
        </div>
      </div>
    </div>
  `).join('');
  
  // Apply lazy loading to images
  const images = tempDiv.querySelectorAll('.lazy-image');
  images.forEach(img => imageObserver.observe(img));
  
  // Clear and append
  container.innerHTML = '';
  while (tempDiv.firstChild) {
    fragment.appendChild(tempDiv.firstChild);
  }
  container.appendChild(fragment);
  
  // Update stats
  updateContactStats(contacts);
}

// Cache for reducing API calls
let contactsCache = {
  data: null,
  timestamp: null,
  params: null
};

function getCacheKey(params) {
  return JSON.stringify(params);
}

async function loadContactsWithCache(page = 1) {
  const search = document.getElementById('searchInput').value;
  const tags = document.getElementById('filterTags').value;
  const engagement = document.getElementById('engagementFilter').value;
  const contactType = document.getElementById('contactTypeFilter').value;
  
  const params = { page, search, tags, engagement, contactType };
  const cacheKey = getCacheKey(params);
  const now = Date.now();
  
  // Use cache if less than 30 seconds old and same params
  if (contactsCache.data && 
      contactsCache.timestamp && 
      (now - contactsCache.timestamp) < 30000 && 
      getCacheKey(contactsCache.params) === cacheKey) {
    displayContactsOptimized(contactsCache.data);
    return;
  }
  
  // Otherwise fetch fresh data
  try {
    const paramString = new URLSearchParams({
      page,
      limit: 20,
      ...(search && { search }),
      ...(tags && { tags }),
      ...(engagement && { engagement }),
      ...(contactType && { contactType })
    });

    const response = await fetchWithAuth(`${API_BASE}/contacts?${paramString}`);
    if (response.ok) {
      const data = await response.json();
      const contacts = data.data?.data || data.data || [];
      
      // Update cache
      contactsCache = {
        data: contacts,
        timestamp: now,
        params: params
      };
      
      displayContactsOptimized(contacts);
      displayPagination(data.data || data);
    } else {
      displayContactsOptimized([]);
    }
  } catch (error) {
    console.error('Error loading contacts:', error);
    displayContactsOptimized([]);
  }
}
</script>
